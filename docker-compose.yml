# ============================================
# üß± DOCKER COMPOSE ‚Äî Open5GS + MongoDB + srsRAN
# (EN/RO bilingual comments)
# ============================================

services:

  # ============================================
  # üß© MongoDB Service ‚Äî Open5GS Core Database
  # ============================================
  mongodb:
    image: mongo:6.0
    container_name: mongodb
    restart: unless-stopped
    privileged: true
    sysctls:                       # ‚úÖ ensures IP forwarding & IPv6 OK everywhere
      net.ipv4.ip_forward: 1
      net.ipv6.conf.all.disable_ipv6: 0
    command: >
      bash -c "
        sysctl -w fs.file-max=6815744 &&
        sysctl -w vm.max_map_count=1677720 &&
        mongod --quiet --bind_ip_all --setParameter diagnosticDataCollectionEnabled=false
      "
    volumes:
      - mongodb_data:/data/db
    networks:
      - open5gs-net
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  # ============================================
  # üß© Open5GS Core Network
  # ============================================
  open5gs:
    build:
      context: .
      dockerfile: open5gs/Dockerfile
    container_name: open5gs
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - open5gs-net
    volumes:
      - ./config/active_config/open5gs:/config/active_config/open5gs
      - ./scripts:/scripts
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    privileged: true
    environment:
      - MONGO_URI=mongodb://mongodb/open5gs
    healthcheck:
      test: ["CMD-SHELL", "pgrep open5gs-nrfd || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

  # ============================================
  # üß© srsRAN ‚Äî Radio Access Network (RAN)
  # ============================================
  srsran:
    build:
      context: .
      dockerfile: srsran/Dockerfile
    container_name: srsran
    depends_on:
      - open5gs
    restart: unless-stopped
    privileged: true
    networks:
      - open5gs-net

# ============================================
# üåê Docker network shared by all containers
# ============================================
networks:
  open5gs-net:

# ============================================
# üíæ Persistent storage volumes
# ============================================
volumes:
  mongodb_data:
