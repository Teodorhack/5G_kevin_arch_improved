version: "3.9"

services:
  mongodb:
    image: mongo:6.0
    container_name: mongodb
    restart: unless-stopped
    privileged: true
    command: >
      bash -c "
        sysctl -w fs.file-max=6815744 &&
        sysctl -w vm.max_map_count=1677720 &&
        mongod --quiet --bind_ip_all --setParameter diagnosticDataCollectionEnabled=false
      "
    volumes:
      - mongodb_data:/data/db
    networks:
      - open5gs-net
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  open5gs:
    build:
      context: .
      dockerfile: open5gs/Dockerfile
    container_name: open5gs
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - open5gs-net
    volumes:
      - ./config/active_config/open5gs:/config/active_config/open5gs
      - ./scripts:/scripts
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    privileged: true
    environment:
      - MONGO_URI=mongodb://mongodb/open5gs
    healthcheck:
      test: ["CMD-SHELL", "pgrep open5gs-nrfd || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s
    command: >
      bash -c "
        echo 'ðŸ”§ Updating MongoDB URIs...';
        find /config/active_config/open5gs -type f -name '*.yaml' -exec sed -i 's|mongodb://localhost/open5gs|mongodb://mongodb/open5gs|g' {} \;;
        echo 'âœ… Configs updated. Starting Open5GS...';
        /scripts/start-open5gs.sh
      "

  srsran:
    build:
      context: .
      dockerfile: srsran/Dockerfile
    container_name: srsran
    depends_on:
      - open5gs
    restart: unless-stopped
    privileged: true
    networks:
      - open5gs-net

networks:
  open5gs-net:

volumes:
  mongodb_data:
