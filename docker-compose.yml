# ============================================
# ğŸ§± DOCKER COMPOSE â€” Open5GS + MongoDB + srsRAN
# ============================================

version: "3.9"

services:

  # ============================================
  # ğŸ§© MongoDB Service â€” Open5GS Core Database
  # ============================================
  mongodb:
    image: mongo:6.0
    container_name: mongodb
    restart: unless-stopped
    privileged: true
    sysctls:
      net.ipv4.ip_forward: 1
      net.ipv6.conf.all.disable_ipv6: 0
    command: >
      bash -c "
        sysctl -w fs.file-max=6815744 &&
        sysctl -w vm.max_map_count=1677720 &&
        mongod --quiet --bind_ip_all --setParameter diagnosticDataCollectionEnabled=false
      "
    volumes:
      - mongodb_data:/data/db
    networks:
      - open5gs-net
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  # ============================================
  # ğŸ§© Open5GS Core Network
  # ============================================
  open5gs:
    build:
      context: .
      dockerfile: open5gs/Dockerfile
    container_name: open5gs
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - open5gs-net
    volumes:
      - ./config/active_config/open5gs:/config/active_config/open5gs
      - ./scripts:/scripts
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    privileged: true
    environment:
      - MONGO_URI=mongodb://mongodb/open5gs
    healthcheck:
      test: ["CMD-SHELL", "pgrep open5gs-nrfd || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

  # ============================================
  # ğŸ§© srsRAN â€” Radio Access Network (RAN)
  # ============================================
  srsran:
    build:
      context: .
      dockerfile: srsran/Dockerfile
    container_name: srsran
    depends_on:
      - open5gs
    restart: unless-stopped
    privileged: true
    networks:
      - open5gs-net

    # ğŸ”Œ Expune SDR-ul Ettus B205mini-i din host cÄƒtre container
    devices:
      - /dev/bus/usb:/dev/bus/usb

    # âš™ï¸ Environment â€” control log, comportament UHD
    environment:
      - UHD_LOG_LEVEL=info
      - DEBIAN_FRONTEND=noninteractive

    # ğŸ“‚ Volumes â€” include config complet srsRAN
    volumes:
      - ./scripts:/scripts
      - ./external/srsran-src:/srsran-src
      - ./config/active_config/srsran:/srsran-config

    # ğŸ©º Healthcheck â€” verificÄƒ dacÄƒ procesul gNB ruleazÄƒ
    healthcheck:
      test: ["CMD-SHELL", "pgrep srsran_app || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s


# ============================================
# ğŸŒ Docker network shared by all containers
# ============================================
networks:
  open5gs-net:

# ============================================
# ğŸ’¾ Persistent storage volumes
# ============================================
volumes:
  mongodb_data:
